<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Agent Demo æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      .loading {
        color: #007bff;
        font-style: italic;
      }
      .task-breakdown {
        background: #e7f3ff;
        padding: 10px;
        border-left: 4px solid #007bff;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ‰ AI Agent Demo åŠŸèƒ½æµ‹è¯•</h1>

    <div class="test-section">
      <h2>1. LoadingçŠ¶æ€æµ‹è¯•</h2>
      <button onclick="testAIResponse()">
        æµ‹è¯•AIå“åº”ï¼ˆå«Loadingå’Œä»»åŠ¡åˆ†è§£ï¼‰
      </button>
      <div id="loading-result" class="result"></div>
    </div>

    <div class="test-section">
      <h2>2. ä»»åŠ¡åˆ†è§£æ˜¾ç¤ºæµ‹è¯•</h2>
      <button onclick="testTaskBreakdown()">æµ‹è¯•ä»»åŠ¡åˆ†è§£API</button>
      <div id="task-result" class="result"></div>
    </div>

    <div class="test-section">
      <h2>3. ç»¼åˆåŠŸèƒ½æµ‹è¯•</h2>
      <button onclick="testFullFeatures()">æµ‹è¯•å®Œæ•´åŠŸèƒ½</button>
      <div id="full-result" class="result"></div>
    </div>

    <script>
      let isLoading = false;

      function showLoading(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="loading">ğŸ”„ ${message}</div>`;
      }

      function displayTaskBreakdown(taskBreakdown, elementId) {
        const element = document.getElementById(elementId);
        let html = '<div class="task-breakdown"><h4>ğŸ“‹ ä»»åŠ¡åˆ†è§£ï¼š</h4>';

        if (taskBreakdown.immediate_tasks) {
          html += "<h5>ğŸš€ ç«‹å³ä»»åŠ¡ï¼š</h5><ul>";
          taskBreakdown.immediate_tasks.forEach((task) => {
            html += `<li>${task}</li>`;
          });
          html += "</ul>";
        }

        if (taskBreakdown.mid_term_tasks) {
          html += "<h5>ğŸ“… ä¸­æœŸä»»åŠ¡ï¼š</h5><ul>";
          taskBreakdown.mid_term_tasks.forEach((task) => {
            html += `<li>${task}</li>`;
          });
          html += "</ul>";
        }

        if (taskBreakdown.final_preparation) {
          html += "<h5>ğŸ¯ æœ€ç»ˆå‡†å¤‡ï¼š</h5><ul>";
          taskBreakdown.final_preparation.forEach((task) => {
            html += `<li>${task}</li>`;
          });
          html += "</ul>";
        }

        html += "</div>";
        element.innerHTML += html;
      }

      async function testAIResponse() {
        if (isLoading) return;
        isLoading = true;

        showLoading("loading-result", "æ­£åœ¨è°ƒç”¨AIæ¥å£...");

        try {
          const response = await fetch("/api/ai/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              question: "æ¨èæŒ‘æˆ˜å†°é¾™çš„è£…å¤‡",
              sessionId: "test",
            }),
          });

          const data = await response.json();

          let result = "âœ… AIå“åº”æˆåŠŸï¼\n\n";
          result += `å°ç²¾çµå›å¤ï¼š${data.response.fairy_response}\n\n`;

          if (data.response.task_breakdown) {
            result += "âœ… ä»»åŠ¡åˆ†è§£åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼\n\n";
            document.getElementById("loading-result").innerHTML = result;
            displayTaskBreakdown(
              data.response.task_breakdown,
              "loading-result"
            );
          } else {
            document.getElementById("loading-result").innerHTML =
              result + "âŒ æœªæ‰¾åˆ°ä»»åŠ¡åˆ†è§£æ•°æ®";
          }
        } catch (error) {
          document.getElementById(
            "loading-result"
          ).innerHTML = `âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`;
        }

        isLoading = false;
      }

      async function testTaskBreakdown() {
        showLoading("task-result", "æµ‹è¯•ä»»åŠ¡åˆ†è§£åŠŸèƒ½...");

        try {
          const response = await fetch("/api/ai/tasks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              goal: "å‡»è´¥ç«é¾™å¤§é­”ç‹",
              sessionId: "test",
            }),
          });

          const data = await response.json();

          if (data.success && data.taskDecomposition) {
            let result = "âœ… ä»»åŠ¡åˆ†è§£APIæ­£å¸¸å·¥ä½œï¼\n\n";
            result += `ç›®æ ‡åˆ†æï¼š${data.taskDecomposition.goal_analysis}\n\n`;

            document.getElementById("task-result").innerHTML = result;

            if (data.taskDecomposition.immediate_tasks) {
              displayTaskBreakdown(
                {
                  immediate_tasks: data.taskDecomposition.immediate_tasks,
                  mid_term_tasks: data.taskDecomposition.mid_term_tasks,
                  final_preparation: data.taskDecomposition.final_preparation,
                },
                "task-result"
              );
            }
          } else {
            document.getElementById("task-result").innerHTML =
              "âŒ ä»»åŠ¡åˆ†è§£APIå“åº”å¼‚å¸¸";
          }
        } catch (error) {
          document.getElementById(
            "task-result"
          ).innerHTML = `âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`;
        }
      }

      async function testFullFeatures() {
        showLoading("full-result", "æµ‹è¯•å®Œæ•´åŠŸèƒ½ç»„åˆ...");

        try {
          const healthResponse = await fetch("/api/health");
          const healthData = await healthResponse.json();

          let result = "ğŸ¥ æœåŠ¡å™¨å¥åº·çŠ¶æ€ï¼š" + healthData.status + "\n\n";

          const stateResponse = await fetch("/api/game/state/test");
          const stateData = await stateResponse.json();

          result +=
            "ğŸ® æ¸¸æˆçŠ¶æ€åŠ è½½ï¼š" +
            (stateData.success ? "æˆåŠŸ" : "å¤±è´¥") +
            "\n\n";

          result += "ğŸ‰ åŸºç¡€åŠŸèƒ½æµ‹è¯•å®Œæˆï¼";

          document.getElementById("full-result").innerHTML = result;
        } catch (error) {
          document.getElementById(
            "full-result"
          ).innerHTML = `âŒ ç»¼åˆæµ‹è¯•å¤±è´¥ï¼š${error.message}`;
        }
      }
    </script>
  </body>
</html>
